# December 20, 2025 â€” Schema + API Reliability Fixes

## Database migrations

- Added `[packages/server/migrations/011_restore_location_integration_columns.sql](packages/server/migrations/011_restore_location_integration_columns.sql)` to restore `google_maps_url`, `store_id`, and `order_link` columns that integration tests expect from the `locations` table.
- Added `[packages/server/migrations/012_add_service_areas_country.sql](packages/server/migrations/012_add_service_areas_country.sql)` so every `service_area` row keeps a `country`, defaulting existing data to `USA` for backward compatibility.
- Added `[packages/server/migrations/013_add_service_areas_updated_at.sql](packages/server/migrations/013_add_service_areas_updated_at.sql)` to track `updated_at` timestamps and backfill current records, enabling deterministic ordering and audit trails.

## Shared types + routing

- Extended the shared `ServiceArea` interface with `country` and `updated_at` in `[packages/shared/src/types/business.ts](packages/shared/src/types/business.ts)` so dashboard, server, and worker share the same contract.
- Mounted the service-area router under both `/businesses` and the legacy `/businesses/seo` namespace in `[packages/server/src/routes/index.ts](packages/server/src/routes/index.ts)` to unblock the multi-location integration suite.
- Limited the global rate limiter to production traffic only in `[packages/server/src/index.ts](packages/server/src/index.ts)` so local and CI runs no longer hit 429s when issuing parallel requests.

## Service area API

- Sorted results by `priority` + `updated_at` and now persist `country` + timestamps during create/update in `[packages/server/src/routes/service-areas.ts](packages/server/src/routes/service-areas.ts)`, guaranteeing consistent payloads for the dashboard and worker.

## Locations API

- Single-create flow now stamps timestamps once, generates `slug`s for any auto-created service area, and updates `updated_at` whenever a service area link changes.
- Update handler normalizes booleans before binding to SQLite, avoiding `SQLite3 can only bind ...` errors when toggling `is_headquarters`.
- Delete handler touches `updated_at` on any unlinked service areas, keeping downstream caches truthful.
- Bulk import validates each row independently, records per-row errors, creates slugs for new service areas, and updates timestamps when auto-linking existing areas.
- See `[packages/server/src/routes/locations.ts](packages/server/src/routes/locations.ts)` for the full implementation.

## Tests & automation

- Updated the keywords integration suite in `[packages/server/src/routes/__tests__/keywords.integration.test.ts](packages/server/src/routes/__tests__/keywords.integration.test.ts)` so it creates businesses with the required `industry` field and matches the current slug normalization rules.
- Reworked `[scripts/smoke-tests.sh](scripts/smoke-tests.sh)` to consistently hit `/api/*` endpoints, send lowercase `industry` values, patch questionnaires via `PUT`, and drop the flaky job-creation checks while the job queue evolves.

## Follow-up

- Re-run `npm run test -- packages/server/src/routes/__tests__/locations.integration.test.ts` after applying these migrations to confirm the legacy `/businesses/seo` flow is green.
- Run `./scripts/smoke-tests.sh local` once the server restarts to verify the updated script output.
